# keycloak-event-listener-user-state

A Keycloak SPI preconfigured to detect user attribute changes and publish events to a MQTT broker.
The payload is a json object, which consists of two attributes:
- event: `org.keycloak.events.Event` or `org.keycloak.events.admin.AdminEvent`
- user: `UserModelDto` which is contains subset of `org.keycloak.models.UserModel` attributes (You can extend this class to your actual needs) 

Inspired by: [ @mhui mhuin/keycloak-event-listener-mqtt SPI ](https://github.com/softwarefactory-project/keycloak-event-listener-mqtt)

# Build

```
mvn clean install
```

# Configuration

Configuration for SPI is extracted to a standalone Java class called `SpiConfigProperties`. 
You can quickly skim through the code to find default values. Most of them are self-explanatory, but:
- `handledEventTypes` property - filters out Keycloak Events (generated by user, not an admin) to any of its values, 
so that particular `EventType` fires, the mqtt publisher publishes actual user data to a mqtt broker

# Deploy

## Keycloak on Quarkus

* Copy the jar archive to /opt/keycloak/providers/ in the keycloak container.
* run keycloak with the following options:

```
kc.sh start
  --spi-events-listener-user-state-server-uri "tcp://your.mqtt.server:port" \
  --spi-events-listener-user-state-username mqtt_user \
  --spi-events-listener-user-state-password mqtt_password \
  --spi-events-listener-user-state-user-event-topic my_topic \
  --spi-events-listener-user-state-admin-event-topic my_topic \
  --spi-events-listener-user-state-use-persistence true
  
```